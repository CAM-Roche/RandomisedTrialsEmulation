#include <Rcpp.h>
using namespace Rcpp;

//' Expand Function
//' 
//' @param d A dataframe with for_period, period_new and switch_new columns
//' @param range The range of the period values 
//' @param first_period First period value to start expanding about

// [[Rcpp::plugins(openmp)]]
// [[Rcpp::export(expand_func)]]
DataFrame expand_func(DataFrame d, int range, int first_period){
  int n = d.nrows();
  IntegerVector ex (range, 1);
  IntegerVector expand (n, 1);
  IntegerVector t_period = d["for_period"];
  IntegerVector t_new = d["period_new"];
  IntegerVector t_switch = d["switch_new"];
  for(int i=0; i<n; i++){
    expand[i] = ex[t_period[i]];
    if(t_period[i] == t_new[i] & t_switch[i] == 1){
      IntegerVector idx = seq(first_period, t_period[i]);
      ex[idx] = 0;
    }
  }
  return(expand);
}
        
//' Censoring Function
//' 
//' @param sw_data A dataframe with the columns needed in censoring process

// [[Rcpp::plugins(openmp)]]
// [[Rcpp::export(censor_func)]]
DataFrame censor_func(DataFrame sw_data){
  int n = sw_data.nrows();
  IntegerVector started0 = sw_data["started0"];
  IntegerVector started1 = sw_data["started1"];
  IntegerVector stop0 = sw_data["stop0"];
  IntegerVector stop1 = sw_data["stop1"];
  IntegerVector eligible0_sw = sw_data["eligible0_sw"];
  IntegerVector eligible1_sw = sw_data["eligible1_sw"];
  LogicalVector delete_ = sw_data["delete"];
  
  IntegerVector t_first = sw_data["first"];
  IntegerVector t_eligible = sw_data["eligible"];
  IntegerVector t_treatment = sw_data["treatment"];
  IntegerVector t_switch = sw_data["switch"];
  
  int started0_ = 0;
  int started1_ = 0;
  int stop0_ = 0;
  int stop1_ = 0;
  int eligible0_sw_ = 0;
  int eligible1_sw_ = 0;
  
  for(int i=0; i<n; i++){
    if(t_first[i]){
      started0_ = 0;
      started1_ = 0;
      stop0_ = 0;
      stop1_ = 0;
      eligible0_sw_ = 0;
      eligible1_sw_ = 0;
    }
    if(stop0_ == 1 | stop1_ == 1){
      started0_ = 0;
      started1_ = 0;
      stop0_ = 0;
      stop1_ = 0;
      eligible0_sw_ = 0;
      eligible1_sw_ = 0;
    }
    if(started0_ == 0 & started1_ == 0 & t_eligible[i] == 1){
      if(t_treatment[i] == 0){
        started0_ = 1;
      }else if(t_treatment[i] == 1){
        started1_ = 1;
      }
    }
    if(started0_ == 1 & stop0_ == 0){
      eligible0_sw_ = 1;
      eligible1_sw_ = 0;
    }else if(started1_ == 1 & stop1_ == 0){
      eligible0_sw_ = 0;
      eligible1_sw_ = 1;
    }else{
      eligible0_sw_ = 0;
      eligible1_sw_ = 0;
    }
    if(t_switch[i] == 1){
      if(t_eligible[i] == 1){
        if(t_treatment[i] == 1){
          started1_ = 1;
          stop1_    = 0;
          started0_ = 0;
          stop0_    = 0;                     
          eligible1_sw_ = 1;
        }else if(t_treatment[i] == 0){
          started0_ = 1;
          stop0_    = 0;
          started1_ = 0;
          stop1_    = 0;
          eligible0_sw_ = 1;
        }
      }else{
        stop0_ = started0_ ;
        stop1_ = started1_ ;
      }
    }
    if(eligible0_sw_ == 0 & eligible1_sw_ == 0){
      delete_[i] = true;
    }else{
      started0[i] = started0_;
      started1[i] = started1_;
      stop0[i] = stop0_;
      stop1[i] = stop1_;
      eligible1_sw[i] = eligible1_sw_;
      eligible0_sw[i] = eligible0_sw_;
      delete_[i] = false;
    }
  }
  sw_data["started0"] = started0;
  sw_data["started1"] = started1;
  sw_data["stop0"] = stop0;
  sw_data["stop1"] = stop1;
  sw_data["eligible0_sw"] = eligible0_sw;
  sw_data["eligible1_sw"] = eligible1_sw;
  sw_data["delete"] = delete_;
  return(sw_data);
}